성공과 실패를 결정하는 1%의 네트워크 원리 읽으면서 정리

# 5. 서버측의 LAN에는 무엇이 있는가

패킷이 서버를 향해 나아가서 서버의 바로 앞에 있는 방화벽, 캐시서버, 부하 분산 장치등을 통과하는 부분에 대해서 다룬다.  

**목차**
1. 웹 서버의 설치 장소
   1. 서버는 어디에 있는 걸까?
2. 방화벽의 원리와 동작
   1. 방화벽은 어떤 개념과 구조로 웹 서버를 지키는 것 일까?
3. 복수 서버에 리퀘스트를 분배한 서버의 부하 분산
   1. 웹 서버에 대한 액세스 수가 많은 대규모 사이트에서는 어떻게 처리할까
   2. 여러대의 웹 서버를 갖추어 부하를 분담하는 방법
4. 캐시서버를 이용한 서버의 부하 분산
   1. 한번 액세스한 데이터를 캐시 서버에 보존해두고 두 번째 이후에 액세스할 때 이용하는 것
   2. 캐시서버를 두는 위치, 다양한 사용법
5. 콘텐츠 배포 서비스
   1. 캐시서버의 발전 버전
   2. 사용자로부터 가장 가까운 캐시 서버에 액세스하도록 처리하는 것
   3. 어떻게 사용자로부터 가장 가까운 캐시 서버를 찾을까?
   4. 캐시서버에 액세스하도록 처리하는 방법


---
<br/>

## 웹 서버의 설치 장소
### 1. 사내에 웹 서버를 설치하는 경우
- 사내의 LAN에 서버를 설치하고 직접 인터넷에서 엑세스 하는 경우
  - 패킷은 가장 가까운 POP에 있는 라우터, 액세스회선, 서버측 라우터를 경유하여 서버 머신에 도착함
  - [단점] IP 주소의 부족
    - LAN에 설치한 기기에는 서버 뿐 아니라 클라이언트에도 글로벌 주소를 할당해야하는데 이러기는 어렵다.
  - [단점] 보안상의 이유
    - 이 형태는 인터넷에서 도착하는 패킷을 차단하는 것이 아니다. 노출 상태로서 공격자의 눈 앞에 방치된다.
    - 사소한 설정 실수등에 의해 무방비 상태가 되어버릴 수 있다.
- 방화벽으로 분리하는 경우 -> <span style="color:blue"> 일반화 된 방법 </span>
  - 방화벽이 관문의 역할을 하여 특정 서버에서 동작하는 특정 어플리케이션에 액세스하는 패킷만 통과시키고, 그 외의 패킷은 차단하는 역할을 한다.
  - 액세스를 허가한 애플리케이션에 보안 구멍이 있으면 공격받을 위험성이 남아있긴 하지만, 전부 무방비 상태가 되는것에 비하면 위험성이 낮다.

### 2. 데이터 센터에 웹 서버를 설치하는 경우
웹 서버는 회사 안에만 설치하지는 않는다. 프로바이더 등이 운영하는 데이터 센터라는 시설에 서버를 가지고 들어가 설치하거나, 프로바이더가 소유하는 서버를 빌려쓰는 형태로 운영

데이터 센터는 프로바이더의 중심 부분에 있는 NOC에 직접 접속되었거나 프로바이더들이 상호접속하는 IX에 직결되어있다.
서버의 운영, 설치 등 부가 서비스를 제공하기도 하고 회사 안 보다는 안전성도 높다.

### 3. 공통점
어느 경우든지 패킷은 라우터에서 중계되고 최종적으로 서버에 도착한다는 점은 달라지지 않는다.

---
## 방화벽의 원리와 동작

### 1. 패킷 필터링형이 주류이다.
서버의 설치 장소와 관계 없이 지금은 바로 앞에 방화벽이 있는것이 보통이다. 그래서 패킷이 방화벽을 통과하는 곳 부터 서버측의 탐험이 시작된다.

```bash
- 방화벽
앞에서 설명했듯이 특정 서버와 해당 서버 안의 특정 애플리케이션에 액세스하는 패킷만 통과시키고, 그 외의 패킷은 차단한다.

네트워크에는 다양한 종류의 패킷이 많이 흐르는데 이 중에서 통과시킬 패킷과 차단할 패킷을 선별하는 것은 간단한 일이 아니다.
- 패킷 필터링형
- 애플리케이션 게이트웨이형
- 서킷 게이트형

성능,가격,사용 편의성 등의 이유로 지금은 "패킷 필터링"형이 가장 보급되었다.
```

### 2. 패킷 필터링의 조건 설정 개념
패킷의 헤더에는 통신 동작을 제어하는 정보가 들어있으므로 이것을 조사하면 여러가지를 알 수 있다.
<table border="1">
<tr>
    <th>헤더 종류 </th>
    <th>조건에서 사용하는 항목</th>
    <th>설명</th>
</tr>
<tr>
    <td> MAC 헤더</td>
    <td> 송신처 MAC 주소 </td>
    <td> 라우터는 패킷을 중계할 때 MAC 주소를 바꿔쓰고 , 중계 대상 라우터의 MAC 주소는 수신처 MAC 주소 항목에, 자신의 MAC주소는 송신처 MAC 주소 항목에 기록한다. 송신처 MAC 주소를 조사해서 직전에 중계한 라우터의 MAC 주소를 알 수 있다. </td>
</tr>
<tr  >
    <td rowspan="3"> IP 헤더 </td>
    <td>송신처 IP 주소 </td>
    <td> 패킷을 최초로 송신한 기기의 IP 주소, 패킷을 송신한 기기를 조건으로 설정하는 경우에 사용한다.</td>
</tr>
<tr>
    <td>수신처 IP 주소 </td>
    <td>패킷을 건네줄 대상의 IP 주소, 패킷이 갈 목적지를 조건으로 설정하는 경우에 사용한다. </td>
</tr>
<tr>
    <td> 프로토콜 번호 </td>
    <td> TCP/IP 프로토콜은 프로토콜 종류마다 번호가 할당되어있다. 프로토콜의 종류를 조건으로 설정할 경우에는 이 번호를 사용한다. <br/>
    IP:0, ICMP:1, TCP:6, UDP:17, OSPF: 89</td>
</tr>
<tr >
    <td rowspan="4"> TCP 헤더 또는 UDP 헤더 </td>
    <td>송신저 포트 번호 </td>
    <td>패킷을 송신한 프로그램에 할당된 포트 번호. 서버 프로그램에 할당된 포트 번호는 고정되어 있으므로 서버에서 반송된 패킷의 포트 번호에서 서버 프로그램을 판별할 수 있다. 그러나 클라이언트 측 프로그램의 포트 번호는 무작위로 할당되므로 이것을 조건으로 설정하지는 않는다.</td>
</tr>
<tr>
    <td>수신처 포트 번호</td>
    <td>패킷을 건네줄 대상의 프로그램에 할당된 포트 번호. 서버의 포트 번호는 조건 설정에사용하는 경우가 있지만, 클라이언트 측의 포트 번호는 거의 사용하지 않는다. </td>
</tr>
<tr>
    <td>TCP 컨트롤 비트 </td>
    <td>
    TCP 프로토콜의 제어에 사용하는 정보. 주로 접속에 관한 제어어 사용<br/>
    - ACK : 수신 데이터의 일련 번호 필드가 유효한 것을 나타낸다. 보통 데이터가 정확하게 도착한것을 수신측에서 송신측에 알릴 때 사용한다.<br/>
    - PSH : 송신측의 애플리케이션 프로그램이 송신 버퍼에 데이터를 저장하지 않고 곧바로 송신하도록 지시하여 송신된 데이터임을 나타낸다.<br/>
    - RST : 접속을 강제로 종료하고, 이상 종료시에 사용한다<br/>
    - SYN : 통신을 개시할 때의 접속 동작에서 최초로 보낸 패킷은 SYN 비트가 1 ACK 비트가 0이다. 이 패킷을 필터링하면 이후의 동작이 이어지지 않고 액세스를 차단할 수 있다.<br/>
    - FIN : 연결 끊기를 나타낸다.
</td>
</tr>
<tr>
    <td>프래그먼트</td>
    <td>IP 프로토콜의 조각 나누기(fragmentation/단편화) 기능으로 패킷을 분할하고 이 패킷이 두 번째 이후임을 나타낸다. </td>
</tr>
<tr>
    <td>헤더가 아니라 ICMP 메세지 내용 </td>
    <td>ICMP 메세지 유형 </td>
    <td>ICMP 메세지는 패킷 배송 도중에 이상이 발생했음을 알리거나 통신 상대의 동작을 확인할 때 사용한다. <br/>
    - O : ping 명령으로 보내는 ICMP 에코 메세지에 응답하는것. 이것과 아래 8을 차단하면 ping명령의 응답이 돌아오지 않는다. <br/>
    - 8 : ICMP 에코. ping명령을 실행하면 ICMP 에코 메세지가 송신된다.<br/>
    - 기타 : ICMP 메세지는 0과 8 이외에도 여러가지가 있지만, 이 중에는 차단하면 네트워크의 동작에 지장을 초래하는것이 있다. 0과 8 이외에 전부 차단하는 것은 주의해야한다.
</td>
</tr>
</table>

<br/>

#### 다음 예시 상황에서의 패킷 필터링의 조건

공개용 서버를 설치하는 LAN과 사내 LAN이 분리되어 있고, 웹 서버는 공개서버용 LAN에 접속되어있을때   
인터넷에서 웹 서버에 대한 액세스를 허가하지 않으면 웹 서버에서 인터넷의 액세스를 금지하도록 패킷을 차단한다.  

- 수신처 IP 주소와 송신처 IP 주소에 따라 시점과 종점을 판단한다.
  - 만약 인터넷과 웹서버라면, 인터넷에서 오는 시점은 지정할 수 없지만 흐름의 종점은 웹서버가 되므로 이것을 조건으로 조건에 해당하는 패킷만 통과시킨다.
    - `시점(송신처 IP)가 어디라도, 종점(수신처 IP)이 웹서버의 IP 주소에 일치하는 패킷만 통과시킨다.`
  - 송신처 IP 주소에 따라 시점을 지정할 수 있으면 이것도 조건에 추가 , 지정할 수 없을땐 조건에 송신처 IP를 지정하지 않아도 된다.

<br/>
<table border="1">
<tr>
<th colspan="5"> 조건</th>
<th rowspan="2"> 통과/차단</th>
</tr>
<tr>
<th>수신처 IP 주소</th>
<th>수신처 포트 번호</th>
<th>송신처 IP 주소</th>
<th>송신처 포트 번호</th>
<th>TCP 컨트롤비트 </th>
</tr>

<tr>
<td>192.0.2.0/24</td>
<td>80</td>
<td></td>
<td></td>
<td></td>
<td>통과</td>
</tr>
<tr>
<td></td>
<td></td>
<td>192.0.2.0/24</td>
<td>80</td>
<td>SYN=1 | ACK=0</td>
<td>차단</td>
</tr>
<tr>
<td></td>
<td></td>
<td>192.0.2.0/24</td>
<td>80</td>
<td></td>
<td>통과</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>차단</td>
</tr>
</table>

<br/>
이렇게 수신처나 송신처의 주소에 따라 패킷이 어디서, 어디로 흘러가는지를 판단하여 통과시킬 것인지 , 차단할 것인지를 결정하는 것이 첫 걸음이다..

<br/>

### 3. 애플리케이션을 한정할 때 포트번호를 사용한다.
- TCP 나 UDP 헤더에 기록되어있는 포트번호를 조건으로 추가

### 4. 컨트롤 비트로 접속 방향을 판단
- 웹의 동작은 TCP 프로토콜을 사용해 양방향으로 패킷이 흐르므로 단순히 흐르는 패킷을 정지시키는 것이 아니라, 액세스 방향을 판단하여 정지시켜야 한다.
- 이때 도움이 되는것이 TCP 헤더에 컨트롤비트
  - 최초 : SYN =1 , ACK = 0  이후 패킷은 해당 상태가 아니므로 최초의 패킷과 두 번째 이후의 패킷을 판별
  - 최초의 패킷을 차단하면 이후 TCP 접속 동작은 실패 -> 이렇게 웹서버에서 인터넷에 액세스 하는 동작을 정지시킴

실제로는 통과,차단을 완전히 선별할 수 없는 경우도 있는데 DNS가 대표적 예이다. (UDP 특징 공통 )   
DNS 서버 조회하는 동작은 UDP 를 사용하는데 **UDP 는 접속단계의 동작이 없어** 이런 설정을 할 수가 없다.   
이와같은 경우에는 패킷 전부 통과, 또는 전부 차단     

- 패킷 필터링의 경우가 아니면 액세스 방향 판단 할수 있긴 함     

### 5. 사내 LAN 에서 공개 서버용 LAN으로 조건을 설정 
### 6. 밖에서 사내 LAN으로 액세스할 수 없다. 
- 주소 변환

### 7. 방화벽을 통과한다.
패킷 필터링 구조는 방화벽의 특징이라기 보단 라우터의 패킷 중계 기능중 일부인데, 라우터에게 부담스러운 작업을 전용 하드웨어나 소프트웨어를 사용하는 것이다.   
복잡한 설정이 없다면 라우터를 방화벽으로 사용할 수도 있다.
### 8. 방화벽으로 막을 수 없는 공격
방화벽은 시점과 종점만 조사한다.   
특수 데이터로 인한 공격,버그를 소프트웨어 업데이트를 통해 해결해야한다.
or 패킷 내용 조사