## 3. 첫 번째 요구사항 추가하기 - 책의 분야



### 21강. 책의 분야 추가하기

- Type, Status
  - Boolean과 Enum의 장단점
- Test FIxture
- Enum + JPA+ Spring Boot



1. 책 등록 요구사항 추가
   1. 등록할 때 '분야'를 선택
   2. 영향범위 파악하기
      - Service, DTO
      - ![스크린샷 2023-06-15 오후 10.50.27](./image/스크린샷%202023-06-15%20오후%2010.50.27.png)





**Test Fixture**

- 생성자를 통해서 데이터를 만드는게 아니라, 정적 팩토리 메서드로 생성하고 테스트에 필요한 Book이 어떻게 생겼는지는 중요하지 않은 부분에서는 Test Fixture를 만들어서 공통으로 사용
- DTO는 그 테스트에만 필요한 경우가 많아서 Fixture로 만들지 않긴 함, 도메인은 Fixture 만들어두면 유용할 것 





![스크린샷 2023-06-15 오후 10.54.19](./image/스크린샷%202023-06-15%20오후%2010.54.19.png)

- companion object는 가장 아래에 선언
- 새로운 컬럼이 추가되었을 때 Fixture로 wrapping해두었기 때문에 다른 테스트 코드는 안고쳐도 됨



### 22강. Enum class를 활용해 책의 분야 리팩토링 하기

- 현재 문제점
  - 요청을 검증하고 있지 않다.
    - COMPUTER 오타가 났는지 등 
  - 코드만 보았을 때 DB테이블에 어떤 값이 들어가는지 알 수 없다.
  - type과 관련된 새로운 로직을 작성할 때 번거롭다.
- 해결 => Enum 클래스 만들기
  - 요청을 검증하고 있지 않다.
    - Enum에 매칭되는게 없으면 알아서 검증해줌
  - 코드만 보았을 때 DB테이블에 어떤 값이 들어가는지 알 수 없다.
    - type: String으로만 된게 아니고 BookType enum 클래스를 보면 무슨 값이 있는지 알 수 있음
  - type과 관련된 새로운 로직을 작성할 때 번거롭다.
    - 이벤트 점수 라는 요구사항이 추가된다면 enum에 프로퍼티를 넣을 수 있을 것 

**서버에는 어떤 값이 들어갈까!**

![스크린샷 2023-06-15 오후 11.05.09](./image/스크린샷%202023-06-15%20오후%2011.05.09.png)

-> enum 0번째라는 의미로 숫자 0이 들어감

- 문제점

  - 순서가 바뀌면 큰 일이 난다. 따라서 Enum의 추가, 삭제가 제한적

- 해결

  - `@Enumerated(EnumType.String)`

  - select * from book;

    | [ID ](http://localhost:8080/h2-console/query.do?jsessionid=55d1c878b54e008afd7f2bf9b223dd0e#) | [NAME ](http://localhost:8080/h2-console/query.do?jsessionid=55d1c878b54e008afd7f2bf9b223dd0e#) | [TYPE ](http://localhost:8080/h2-console/query.do?jsessionid=55d1c878b54e008afd7f2bf9b223dd0e#) |
    | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
    | 1                                                            | 클린 코드                                                    | COMPUTER                                                     |

  



### 23강. Boolean에도 Enum 활용하기 - 책 반납 로직 수정

`UserLoanHistory` 의  `isReturn: Boolean`

1. 또 다른 isActive, isDeleted 필드가 추가되었다면?   

- Boolean이 2개 있기 때문에 코드가 이해하기 어려워짐
  - 점점 추가될수록 어려워질것
- boolean 2개로 표현되는 4가지 상태가 모두 유의미하지 않다.
  - false, false
  - false, true
  - true, false
  - true, true
  - 존재할수가 없는 조합이 생겨버림



2. UserStatus라는 enum에 ACTIVE, DELETED가 있다면 ?!?

- 더 좋을 것이다. 



**No property 'isReturn' found for type 'UserLoanHistory'!**

- JPARepository 사용하면서 findByBookNameAndIsReturn을 사용했는데, 모르고 그냥 사용해버려서 오류가 생김
- JPA사용할때의 단점 -> queryDSL로 다음에 해결해볼 것



### 24강. 첫 번째 요구사항 클리어



----

## 4. 두 번째 요구사항 추가하기 - 도서 대출 현황

- join쿼리의 종류와 차이점
- JPA N+1 문제 , 원인, 해결
- 새로운 API를 만들 때 생길 수 있는 고민



### 25강. 유저 대출 현황 보여주기 

- 유저 대출 현황
- 과거 대출 기록, 현재 대출 기록
- 아무 기록 없는 유저도 보여져야함



**주어진 API 스펙**

```
GET /user/loan
요청 : 파라미터 없음
응답 : [{
	"name" : String,
	"books": [
			"name": String,
			"isReturn": Boolean
	]
}, ...]
```

- 새로운 API를 만들 때 코드의 위치를 어디에 만들어야할까?
  - 새로운 Controller
  - 기존 Controller 어디에?
- 화면에서 사용되는 API 끼리 모아둠
  - +) 화면에서 어떤 API가 사용되는 한 눈에 알기 용이
  - -) 한 API가 여러 화면에서 사용될 경우 위치가 애매하다
  - -) 서버코드가 화면에 종속적이다.
- 동일한 도메인끼리 (이 방법 선택할 것)
  - +) 화면 위치와 무관하게 서버 코드는 변경되지 않아도 됨
  - +) 비슷한 API끼리 모이면 코드위 위치를 예측할 수 있음
  - -) 화면에서 어디서 사용되는지 서버코드만 보고는 알기 어려움
- 1 API 1 Controller (간혹)
  - +) 화면 위치와 무관하게 서버 코드는 변경되지 않아도 됨
  - -) 화면에서 어디서 사용되는지 서버코드만 보고는 알기 어려움



**Controller를 찾을 수 있는 방법**

- API를 알고있을 때
  - Find in Files (command + shift + f)
  - Url 모아두기
  - Intellij endpoints(유료버전)
    - ![스크린샷](./image/스크린샷%202023-06-15%20오후%2011.36.05.png)
